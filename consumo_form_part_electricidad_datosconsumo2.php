<?php

///
/// Parte de DATOS GENERALES de la factura eléctrica.
///

global $variablesPart;

define('FASE_RECOGIDA_FACTURA',4);

define ('FACTURA_ELECTRICIDAD_DATOS_SUMINISTRO_PEAJE_ACCESO','1111.5000.2003');

/////// ENTRADA ///////////////
// oids (atributos del apartado de datos de la potencia facturada)
define('FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P1','1111.5000.2002.0001');
define('FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P2','1111.5000.2002.0002');
define('FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P3','1111.5000.2002.0003');
define('FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P4','1111.5000.2002.0004');
define('FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P5','1111.5000.2002.0005');
define('FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P6','1111.5000.2002.0006');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P1','1111_5000_2002_0001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P2','1111_5000_2002_0002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P3','1111_5000_2002_0003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P4','1111_5000_2002_0004');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P5','1111_5000_2002_0005');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_CONTRATADA_P6','1111_5000_2002_0006');

define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_POTENCIA','1111.6000.1001.1001.1001.0001.1001');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_DIAS','1111.6000.1001.1001.1001.0001.1002');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_PRECIO','1111.6000.1001.1001.1001.0001.1003');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_IMPORTE','1111.6000.1001.1001.1001.0001.1004');

define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_POTENCIA','1111.6000.1001.1001.1001.0002.1001');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_DIAS','1111.6000.1001.1001.1001.0002.1002');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_PRECIO','1111.6000.1001.1001.1001.0002.1003');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_IMPORTE','1111.6000.1001.1001.1001.0002.1004');

define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_POTENCIA','1111.6000.1001.1001.1001.0003.1001');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_DIAS','1111.6000.1001.1001.1001.0003.1002');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_PRECIO','1111.6000.1001.1001.1001.0003.1003');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_IMPORTE','1111.6000.1001.1001.1001.0003.1004');

define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_POTENCIA','1111.6000.1001.1001.1001.0004.1001');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_DIAS','1111.6000.1001.1001.1001.0004.1002');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_PRECIO','1111.6000.1001.1001.1001.0004.1003');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_IMPORTE','1111.6000.1001.1001.1001.0004.1004');

define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_POTENCIA','1111.6000.1001.1001.1001.0005.1001');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_DIAS','1111.6000.1001.1001.1001.0005.1002');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_PRECIO','1111.6000.1001.1001.1001.0005.1003');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_IMPORTE','1111.6000.1001.1001.1001.0005.1004');

define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_POTENCIA','1111.6000.1001.1001.1001.0006.1001');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_DIAS','1111.6000.1001.1001.1001.0006.1002');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_PRECIO','1111.6000.1001.1001.1001.0006.1003');
define('FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_IMPORTE','1111.6000.1001.1001.1001.0006.1004');

define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_POTENCIA','1111_6000_1001_1001_1001_0001_1001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_DIAS','1111_6000_1001_1001_1001_0001_1002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_PRECIO','1111_6000_1001_1001_1001_0001_1003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_IMPORTE','1111_6000_1001_1001_1001_0001_1004');

define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_POTENCIA','1111_6000_1001_1001_1001_0002_1001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_DIAS','1111_6000_1001_1001_1001_0002_1002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_PRECIO','1111_6000_1001_1001_1001_0002_1003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_IMPORTE','1111_6000_1001_1001_1001_0002_1004');

define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_POTENCIA','1111_6000_1001_1001_1001_0003_1001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_DIAS','1111_6000_1001_1001_1001_0003_1002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_PRECIO','1111_6000_1001_1001_1001_0003_1003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_IMPORTE','1111_6000_1001_1001_1001_0003_1004');

define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_POTENCIA','1111_6000_1001_1001_1001_0004_1001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_DIAS','1111_6000_1001_1001_1001_0004_1002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_PRECIO','1111_6000_1001_1001_1001_0004_1003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_IMPORTE','1111_6000_1001_1001_1001_0004_1004');

define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_POTENCIA','1111_6000_1001_1001_1001_0005_1001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_DIAS','1111_6000_1001_1001_1001_0005_1002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_PRECIO','1111_6000_1001_1001_1001_0005_1003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_IMPORTE','1111_6000_1001_1001_1001_0005_1004');

define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_POTENCIA','1111_6000_1001_1001_1001_0006_1001');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_DIAS','1111_6000_1001_1001_1001_0006_1002');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_PRECIO','1111_6000_1001_1001_1001_0006_1003');
define('VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_IMPORTE','1111_6000_1001_1001_1001_0006_1004');


define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_ENERGIA','1111.6000.1001.1002.1001.0001.1001');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_PRECIO','1111.6000.1001.1002.1001.0001.1002');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_IMPORTE','1111.6000.1001.1002.1001.0001.1003');

define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_ENERGIA','1111.6000.1001.1002.1001.0002.1001');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_PRECIO','1111.6000.1001.1002.1001.0002.1002');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_IMPORTE','1111.6000.1001.1002.1001.0002.1003');

define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_ENERGIA','1111.6000.1001.1002.1001.0003.1001');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_PRECIO','1111.6000.1001.1002.1001.0003.1002');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_IMPORTE','1111.6000.1001.1002.1001.0003.1003');

define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_ENERGIA','1111.6000.1001.1002.1001.0004.1001');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_PRECIO','1111.6000.1001.1002.1001.0004.1002');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_IMPORTE','1111.6000.1001.1002.1001.0004.1003');

define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_ENERGIA','1111.6000.1001.1002.1001.0005.1001');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_PRECIO','1111.6000.1001.1002.1001.0005.1002');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_IMPORTE','1111.6000.1001.1002.1001.0005.1003');

define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_ENERGIA','1111.6000.1001.1002.1001.0006.1001');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_PRECIO','1111.6000.1001.1002.1001.0006.1002');
define('FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_IMPORTE','1111.6000.1001.1002.1001.0006.1003');

define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_ENERGIA','1111_6000_1001_1002_1001_0001_1001');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_PRECIO','1111_6000_1001_1002_1001_0001_1002');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_IMPORTE','1111_6000_1001_1002_1001_0001_1003');

define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_ENERGIA','1111_6000_1001_1002_1001_0002_1001');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_PRECIO','1111_6000_1001_1002_1001_0002_1002');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_IMPORTE','1111_6000_1001_1002_1001_0002_1003');

define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_ENERGIA','1111_6000_1001_1002_1001_0003_1001');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_PRECIO','1111_6000_1001_1002_1001_0003_1002');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_IMPORTE','1111_6000_1001_1002_1001_0003_1003');

define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_ENERGIA','1111_6000_1001_1002_1001_0004_1001');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_PRECIO','1111_6000_1001_1002_1001_0004_1002');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_IMPORTE','1111_6000_1001_1002_1001_0004_1003');

define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_ENERGIA','1111_6000_1001_1002_1001_0005_1001');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_PRECIO','1111_6000_1001_1002_1001_0005_1002');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_IMPORTE','1111_6000_1001_1002_1001_0005_1003');

define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_ENERGIA','1111_6000_1001_1002_1001_0006_1001');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_PRECIO','1111_6000_1001_1002_1001_0006_1002');
define('VAR_FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_IMPORTE','1111_6000_1001_1002_1001_0006_1003');


$ult_factura_buscada=false;
$ult_factura=null;
$ult_att=null;


function recogerDatosEntrada()
{
    global $page;
    
    $valores=array();
    
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_POTENCIA]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_POTENCIA, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_DIAS]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_DIAS, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_PRECIO]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_PRECIO, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_IMPORTE]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P1_IMPORTE, NULL);
    
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_POTENCIA]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_POTENCIA, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_DIAS]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_DIAS, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_PRECIO]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_PRECIO, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_IMPORTE]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P2_IMPORTE, NULL);
    
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_POTENCIA]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_POTENCIA, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_DIAS]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_DIAS, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_PRECIO]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_PRECIO, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_IMPORTE]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P3_IMPORTE, NULL);
    
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_POTENCIA]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_POTENCIA, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_DIAS]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_DIAS, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_PRECIO]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_PRECIO, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_IMPORTE]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P4_IMPORTE, NULL);
    
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_POTENCIA]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_POTENCIA, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_DIAS]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_DIAS, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_PRECIO]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_PRECIO, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_IMPORTE]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P5_IMPORTE, NULL);
    
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_POTENCIA]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_POTENCIA, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_DIAS]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_DIAS, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_PRECIO]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_PRECIO, NULL);
    $valores[FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_IMPORTE]=$page->request_post_or_get(VAR_FACTURA_ELECTRICIDAD_POTENCIA_FACTURADA_P6_IMPORTE, NULL);
    
    
    return $valores;
}

function procesarDatosEntrada()
{
    global $page,$factura_ctl,$factura;
    
    if($page->is_post()==false)
    {
        return true;
    }
    
    /// Recogemos los datos de entrada (FACTURACIÓN ENERGÍA)
    $valores=recogerDatosEntrada();
    
    /// Guardamos los datos del apartado rellenado (DATOS DE DETALLES DE LA FACTURACIÓN)
    if($factura_ctl->cargarDatosEntradaEnFactura($factura,$valores,FASE_RECOGIDA_FACTURA)==false)
    {
        return "Error durante la grabación. Operación interrumpida.";
    }
    
    return true;
}

/// TODO: Precargar los campos con los valores de la factura más reciente del mismo tipo.

function getUltimaFactura()
{
    global $factura_ctl,$factura,$ult_factura_buscada,$ult_factura;
    
    if($ult_factura_buscada==false)
    {
        $ult_factura=$factura_ctl->cargar_ultima_factura($factura->id_establecimiento,$factura->tipo,$factura->num_factura);
        $ult_factura_buscada=true;
    }
    return $ult_factura;
}

function getUltimosAtributos()
{
    global $factura_ctl,$factura,$ult_att;
    
    $ult_att=$factura_ctl->cargarAtributosPrevios($factura);
    return $ult_att;
}

function precargaValor($oid)
{
    global $ult_att,$ult_factura;
    
    $valor=null;
    if(array_key_exists($oid,$ult_att))
    {
        $valor=$ult_att[$oid]->valor;
    }
    else
    {
        if(USAR_HISTORIAL_SUGERIR_CONSUMO=='S')
        {
            getUltimaFactura();
            if($ult_factura!=null)
            {
                if(array_key_exists($oid,$ult_factura->detalles))
                {
                    $valor=$ult_factura->detalles[$oid]->valor;
                }
            }
        }
    }
    
    return $valor;
}

// Esta función obtiene el valor de precarga de un atributo cuando se quiere rescartar el valor previo (modificación) pero no sugerencias de facturas previas.
function precargaValorLimitado($oid)
{
    global $ult_att,$ult_factura;
    
    $valor=null;
    if(array_key_exists($oid,$ult_att))
    {
        $valor=$ult_att[$oid]->valor;
    }
    
    return $valor;
}

// Datos para la precarga de campos. Se usan los datos de la factura actual ó los de la última factura similar si existe.
function precargarDatosFactura()
{
    global $factura;
    
    getUltimosAtributos();
    
    $predatos=array();
    
    $nperiodos=0;
    
    $predatos[FACTURA_ELECTRICIDAD_DATOS_SUMINISTRO_PEAJE_ACCESO]=$factura->detalles[FACTURA_ELECTRICIDAD_DATOS_SUMINISTRO_PEAJE_ACCESO]->valor;

    // La factura debe existir y tener informado el tipo de peaje.
    switch($predatos[FACTURA_ELECTRICIDAD_DATOS_SUMINISTRO_PEAJE_ACCESO])
    {
        // 6 periodos
        case '6.1A':
        case '6.1B':
        case '6.2':
        case '6.3':
        case '6.4':
        case '6.5':
            $nperiodos+=3;
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_ENERGIA]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_ENERGIA);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_PRECIO]=precargaValor(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_PRECIO);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_IMPORTE]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_IMPORTE);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_ENERGIA]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_ENERGIA);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_PRECIO]=precargaValor(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_PRECIO);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_IMPORTE]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_IMPORTE);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_ENERGIA]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_ENERGIA);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_PRECIO]=precargaValor(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_PRECIO);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_IMPORTE]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_IMPORTE);  // 3 periodos
        case '2.0DHS':
        case '2.1DHS':
        case '3.0A':
        case '3.1A':
            $nperiodos+=1;
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_ENERGIA]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_ENERGIA);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_PRECIO]=precargaValor(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_PRECIO);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_IMPORTE]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_IMPORTE);
            // 2 periodos
        case '2.0DHA':
        case '2.1DHA':
            $nperiodos+=1;
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_ENERGIA]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_ENERGIA);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_PRECIO]=precargaValor(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_PRECIO);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_IMPORTE]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_IMPORTE);
            // Sin discriminación horaria (1 periodo).
        case '2.0A':
        case '2.1A':
            $nperiodos+=1;
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_ENERGIA]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_ENERGIA);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_PRECIO]=precargaValor(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_PRECIO);
            $predatos[FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_IMPORTE]=precargaValorLimitado(FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_IMPORTE);
            break;
    }
    
    $predatos['fin_periodo']=$factura->fecha_final->format('d/m/Y');
    
    $predatos['numero_periodos']=$nperiodos;
    
    return $predatos;
}

function procesarParteFactura()
{
    global $page,$variablesPart,$numero_factura;
    
    $res=procesarDatosEntrada();
    if($res!==true)
    {
        return $res;
    }
    
    $errores=null;
    /*
    if($res==false)
    {
        /// TODO: Se grabó mal los datos. Debemos recargar el mismo trozo de factura, mostrando el error.
        $subview="consumo_form_part_electricidad_datossuministros_view.php";
        $errores=array("No se han grabado los datos correctamente.");
    }
    */
    
    /// Presentar nueva pantalla.
    $subview=__DIR__ ."/views/consumo_form_part_electricidad_datosconsumo2_view.php";
    $url_next=$page->self_url(array(ARG_PARTE=>'4', ARG_NUMERO_FACTURA=>$numero_factura));
    $url_prev=$page->self_url(array(ARG_PARTE=>'2', ARG_NUMERO_FACTURA=>$numero_factura));
    
    $precarga=precargarDatosFactura();
    
    $mensaje="Está ud. viendo la parte #2";
    $color='green';
    $variablesPart = array(
        'subview'               => $subview,                /// Indicamos qué vista va asociada a este formulario parcial se debe incluir
        'urlNext'               => $url_next,               /// Indica la url a la que se debe saltar al pulsar el botón Siguiente
        'urlPrev'               => $url_prev,               /// Indica la url a la que se debe saltar al pulsar el botón Anterior
        'ColorFondo'            => $color,
        'NumeroFactura'         => $numero_factura,
        'Peaje'                 => $precarga[FACTURA_ELECTRICIDAD_DATOS_SUMINISTRO_PEAJE_ACCESO],
        
        'NumeroPeriodos'        => $precarga['numero_periodos'],
        'FechaFinalPeriodo'     => $precarga['fin_periodo'],
        'texto'                 => $mensaje,
        'errores'               => $errores
    );
    
    $listaOids=array(0,FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_ENERGIA,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_ENERGIA,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_ENERGIA,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_ENERGIA,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_ENERGIA,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_ENERGIA);
    for($i=1;$i<=6;$i++)
    {
        if(array_key_exists($listaOids[$i],$precarga))
        {
            $variablesPart['P'.$i.'_energia']=$precarga[$listaOids[$i]];
        }
    }
    $listaOids=array(0,FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_PRECIO,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_PRECIO,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_PRECIO,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_PRECIO,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_PRECIO,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_PRECIO);
    for($i=1;$i<=6;$i++)
    {
        if(array_key_exists($listaOids[$i],$precarga))
        {
            $variablesPart['P'.$i.'_precio']=$precarga[$listaOids[$i]];
        }
    }
    $listaOids=array(0,FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P1_IMPORTE,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P2_IMPORTE,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P3_IMPORTE,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P4_IMPORTE,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P5_IMPORTE,
        FACTURA_ELECTRICIDAD_ENERGIA_FACTURADA_P6_IMPORTE);
    for($i=1;$i<=6;$i++)
    {
        if(array_key_exists($listaOids[$i],$precarga))
        {
            $variablesPart['P'.$i.'_importe']=$precarga[$listaOids[$i]];
        }
    }
    
    return true;
}

?>